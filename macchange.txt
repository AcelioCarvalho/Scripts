#!/bin/bash
# By: Vinicius Silva
# Revision: Acelio Silva

# Database credentials
DB_PSQL="psql -U postgres brcconfig"

# Get list of network interfaces
interfaces=$(ifconfig -a | grep -ioE "eth[0-9]+: " | tr -d ':')

# Loop through each interface
for eth in $interfaces; do
  # Get physical MAC address
  mac_phys=$(ethtool -P "$eth" | awk '{print $3}')

  # Get MAC address from database
  mac_db=$($DB_PSQL -t -A -c "SELECT macaddrs FROM box_net_device WHERE name='$eth';")

  # Compare MAC addresses
  if [ "$mac_phys" != "$mac_db" ]; then
    # show MAC addresses before update
    echo -e "Interface: $eth\nNew MAC: $mac_phys\nOld MAC: $mac_db\n"

    # Update MAC address in database
    $DB_PSQL -c "UPDATE box_net_device SET macaddrs = '$mac_phys' WHERE name='$eth';" &> /dev/null

    # Reload interface
    /opt/omne/apply/omne-apply-eth -i "$eth"
  fi
done
