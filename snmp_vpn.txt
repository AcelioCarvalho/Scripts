#!/bin/bash
# Por: Acelio Silva

# Dependecia da conf do SNMPv3
if ! grep "rouser bbsuporte"  /etc/snmp/snmpd.conf; then

    echo "SNMPv3 do Suporte n√£o configurado"
    exit 0
fi

echo "Configurando as novas MIBs ..."

/usr/bin/sed -i '/ipsec_connecting/a extend XFRMOUT \/bin\/bash \/opt\/omne\/conf\/mibs\/xfrm_out' /etc/snmp/snmpd.conf
/usr/bin/sed -i '/ipsec_connecting/a extend XFRMIN \/bin\/bash \/opt\/omne\/conf\/mibs\/xfrm_in' /etc/snmp/snmpd.conf
/usr/bin/sed -i '/ipsec_connecting/a extend IPSECSTATUS \/bin/bash \/opt\/omne\/conf/mibs\/ipsec_status' /etc/snmp/snmpd.conf
/usr/bin/sed -i '/ipsec_connecting/a extend IPSECSTATE \/bin/\bash \/opt\/omne\/conf\/mibs\/ipsec_state' /etc/snmp/snmpd.conf
/usr/bin/sed -i '/ipsec_connecting/a extend IPSECNAME \/bin\/bash \/opt\/omne\/conf\/mibs\/ipsec_name' /etc/snmp/snmpd.conf

# Configurando dos scripts
cat << EOF > /opt/omne/conf/mibs/xfrm_in
#!/bin/bash

grep XfrmInStateProtoError /proc/net/xfrm_stat | awk '{print \$2}'
EOF

cat << EOF > /opt/omne/conf/mibs/xfrm_out

#!/bin/bash

grep XfrmOutStateProtoError /proc/net/xfrm_stat | awk '{print \$2}'
EOF

cat << EOF > /opt/omne/conf/mibs/ipsec_name
#!/bin/bash

/usr/bin/psql -U postgres brcconfig -t -A -c "select tunnel_name from vpn_ipsec_tunnel ;"
EOF

cat << EOF > /opt/omne/conf/mibs/ipsec_state
#!/bin/bash

for id in \$(psql -U postgres brcconfig -t -A -c "select tunnel_id from vpn_ipsec_tunnel ;")

do

state=\$(psql -U postgres brcconfig -t -A -c "select cfgkey from vpn_ipsec_tunnel_config where cfgkey = 'enabled' AND tunnel_id ='\$id' ;")

        if [ -z "\$state" ]; then

                echo "disabled"
         else
                echo "enabled"
        fi
done
exit 0
EOF

cat << EOF > /opt/omne/conf/mibs/ipsec_status
#!/bin/bash

for id in \$(psql -U postgres brcconfig -t -A -c "select tunnel_id from vpn_ipsec_tunnel ;")
do

        if ! strongswan status tun\$id | grep "ESTABLISHED" &>/dev/null
         then
                echo "0"
        else
                echo "1"

        fi
done
exit 0
EOF

/usr/bin/systemctl restart snmpd

echo "Finalizado"
exit 0
